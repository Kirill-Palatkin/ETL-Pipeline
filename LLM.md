# LLM.md

## Правила работы LLM для ETL проекта

**Цель:** создавать краткие аналитические выводы по результатам ETL (без придумывания цифр и фактов)

---

## Общие правила

- **Использовать только реальные данные из ETL:**
  - Таблицы: `uplift_by_store`, `ads_metrics`, `anomalies`
  - Метрики: `units`, `revenue`, `ctr`, `cpc`
  - Группировки: `store_id`, `channel`

- **Не генерировать вымышленные цифры:**
  - Все числа, проценты, медианы и IQR берутся из результатов трансформации
  - Если данных нет, формулировать вывод абстрактно (шаблон)

- **Фокус на выявленных аномалиях:**
  - Указывать каналы или витрины с аномалиями
  - Предлагать проверку источников данных, кампаний, `promo_flag`
  - Не добавлять «магические» решения или рекомендации

- **Формулировка:**
  - 3–5 предложений
  - Лаконично: «что произошло и где копать»

---

## Шаблонные формулировки (если `USE_LLM=0`)

> "Проверьте указанные витрины/каналы и периоды, сопоставьте кампании и промо-активности. (USE_LLM=1 для авто-выводов)"

> "Аномалий не обнаружено; фокус — обычная проверка распределения трафика и корректности импутаций."

---

## Пример вывода LLM (USE_LLM=1)

> "Наблюдаются аномалии в следующих рекламных каналах: X, Y.  
> Рекомендация: проверить таргетинг/кампании и распределение показов в указанных каналах; сверить данные кликов и затрат в периоды с аномалиями.  
> Также проверить соответствие `promo_flag` в витринах, где uplift по выручке сильно отличается от среднего."

---

## Настройка

- Включение LLM анализа: `USE_LLM=1` для включения LLM, `USE_LLM=0` - для выключения. Настраивается в`.env`  
- Флаг командной строки: `--explain` (по умолчанию делает`USE_LLM=1`) при запуске `etl.py run_all`  
- Если `USE_LLM=0`, формируется только шаблонное объяснение

---

## Задача LLM

1. Сгенерировать краткий аналитический блок в отчёте `report.md`.
2. Использовать только реальные результаты ETL.
3. Не создавать данные, которых нет в исходных таблицах.
